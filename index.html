<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <script id="ssg-data" type="application/json">{"streamTemplates":[{"fn":"(x) => Math.floor(x)","args":[{"type":"stream","value":1}]},{"fn":"(...args) => args.reduce((a, b) => a * b, 1)","args":[{"type":"stream","value":2},{"type":"value","value":0.001}]},{"value":0,"fn":"() => {\n    console.log(\"time\");\n    return 0;\n  }","args":[]}]}</script><script type="module">import S from "https://cdn.skypack.dev/s-js";
import reconcile from "./reconcile.js";

const time = S.data(0);
function loop(t = 0) {
  time(t);
  requestAnimationFrame(loop);
}
loop();

const namedStreams = {
  time,
};

const deserialize = (string) => {
  const data = JSON.parse(string).streamTemplates;
  const completed = {};
  const create = (key) => {
    const item = data[key];
    if (completed[key]) {
    } else if ("fn" in item) {
      const args = item.args.map((arg) => {
        if (arg.type === "stream") {
          return create(arg.value);
        } else {
          return () => arg.value;
        }
      });
      const fn = new Function("return " + item.fn)();
      completed[key] = S(() => fn(...args.map((v) => v())));
    } else if ("value" in item) {
      completed[key] = S.data(item.value);
    }
    return completed[key];
  };
  for (let i = 0; i < data.length; i++) {
    create(i);
  }
  return completed;
};

function getStreamNodes(root) {
  const treeWalker = document.createTreeWalker(
    root,
    NodeFilter.SHOW_COMMENT,
    {
      acceptNode: function (node) {
        return node.textContent.startsWith("stream=")
          ? NodeFilter.FILTER_ACCEPT
          : NodeFilter.FILTER_SKIP;
      },
    },
    false
  );
  const result = {};
  let currentNode;
  while ((currentNode = treeWalker.nextNode())) {
    const id = currentNode.textContent.split("=")[1];
    result[id] = currentNode;
  }
  return result;
}

function patch(parent, value, current) {
  while (typeof current === "function") {
    current = current();
  }
  if (value === current) {
    return current;
  }
  const valueType = typeof value;
  if (valueType === "string" || valueType === "number") {
    if (valueType === "number") {
      value = value.toString();
    }
    if (current instanceof Comment) {
      parent.removeChild(current);
    } else if (current instanceof Node) {
      current.nodeValue = value;
      return current;
    } else if (Array.isArray(current)) {
      clear(parent, current);
    }
    value = document.createTextNode(value);
    parent.appendChild(value);
    return value;
  } else if (value == null || valueType === "boolean") {
    return clear(parent, current, value);
  } else if (valueType === "function") {
    return S((acc) => patch(parent, value(), acc), current);
  } else if (Array.isArray(value)) {
    const array = normalize(value);
    if (array.length === 0) {
      return clear(parent, current, "[]");
    } else {
      if (Array.isArray(current)) {
        reconcile(parent, current, array);
      } else if (current instanceof Node) {
        reconcile(parent, [current], array);
      } else {
        for (let i = 0; i < array.length; i++) {
          parent.appendChild(array[i]);
        }
      }
      return array;
    }
  } else if (value instanceof Node) {
    if (Array.isArray(current)) {
      reconcile(parent, current, [value]);
    } else if (current instanceof Node) {
      parent.replaceChild(value, current);
    } else {
      parent.appendChild(value);
    }
    return value;
  } else {
    return current;
  }
}

const streams = deserialize(document.getElementById("ssg-data").textContent);
const nodes = getStreamNodes(document.querySelector("main"));

for (let key in nodes) {
  const node = nodes[key];
  const parent = node.parentNode;
  S((current) => patch(parent, streams[key](), current), node);
}
</script>
  </head>
  <body>
    <main><div id="ssg-content"><div><div style.width="1em" style.height="1em" style.borderRadius="1em" style.backgroundColor="[object Object]"></div><span><!--stream=0--></span></div></div></main>
  </body>
</html>
